#!/bin/sh
#
# A script to automatically modify the "PATCH_LEVEL" in the version file when we commit. 
# The patch level is incremented by one. 
#

# Get the root of the Git repository
REPO_ROOT=$(git rev-parse --show-toplevel)

# Path to the Python script
SCRIPT_PATH="$REPO_ROOT/gitHooks/update_patch_level.py"

# Directory containing version.h and source files
SOURCE_DIR="VCPU32-Simulator"

# Find both staged and unstaged modified files in the source directory
FILES_TO_UPDATE=$(git diff --name-only --diff-filter=AM "$SOURCE_DIR")
STAGED_FILES=$(git diff --cached --name-only --diff-filter=AM "$SOURCE_DIR")

if [ -z "$FILES_TO_UPDATE" ] && [ -z "$STAGED_FILES" ]; then
    echo "No changes detected in $SOURCE_DIR. Skipping patch level update."
    exit 0
fi

# Version file path
VERSION_FILE="$REPO_ROOT/VCPU32-Simulator/VCPU32-Version.h"

# Update the patch level using Python
python3 "$SCRIPT_PATH" "$VERSION_FILE"

# Stage the modified version file
git add "$VERSION_FILE"

echo "PATCH_ LEVEL updated in version.h."

# Allow the commit to proceed
exit 0
